<section class="card">
  <h1>Dashboard</h1>
  <div class="stats">
    <div class="stats-item">
      <h2>{{ taskStore.totalCount() }} Tasks</h2>
      <p>in total</p>
    </div>
    <div class="stats-item">
      <h2>{{ taskStore.openCount() }} Tasks</h2>
      <p>open</p>
    </div>
    <div class="stats-item">
      <h2>{{ taskStore.doneCount() }} Tasks</h2>
      <p>done</p>
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div>
      <label for="newTitle">Title</label>
      <input
        id="newTitle"
        type="text"
        formControlName="title"
        placeholder="add new Task"
        [attr.aria-invalid]="titleCtrl.invalid && titleCtrl.touched ? 'true' : null"
        [attr.aria-describedby]="titleCtrl.invalid && titleCtrl.touched ? 'new-title-error' : null"
      />
      @if (titleCtrl.invalid && titleCtrl.touched) {
        <p id="new-title-error" class="error" aria-live="polite">
          Title must be at least 3 characters
        </p>
      }
      <label for="new-description">Description</label>
      <textarea
        id="new-description"
        formControlName="description"
        placeholder="add description"
        rows="4"
      ></textarea>
    </div>
    <button class="btn" type="submit" [disabled]="form.invalid">Add Task</button>
  </form>

  <div class="filter-bar">
    <button
      class="btn"
      type="button"
      (click)="taskStore.setFilter('all')"
      [class.active]="taskStore.filter() === 'all'"
    >
      All
    </button>
    <button
      class="btn"
      type="button"
      (click)="taskStore.setFilter('open')"
      [class.active]="taskStore.filter() === 'open'"
    >
      Open
    </button>
    <button
      class="btn"
      type="button"
      (click)="taskStore.setFilter('done')"
      [class.active]="taskStore.filter() === 'done'"
    >
      Done
    </button>
  </div>

  <button class="btn" type="button" (click)="taskStore.resetDemoData()">Reset Tasks</button>

  <div class="task-list">
    <ul>
      @for (task of taskStore.filteredTasks(); track task.id) {
        <li>
          @if (taskStore.editingTaskId() === task.id) {
            <input
              #titleInput
              [attr.data-edit-title-id]="task.id"
              type="text"
              (input)="taskStore.setDraftTitle(titleInput.value)"
              [value]="taskStore.draftTitle()"
              (keydown.enter)="taskStore.saveEdit(task.id)"
              (keydown.escape)="taskStore.cancelEdit()"
              [attr.aria-invalid]="taskStore.editError() ? 'true' : null"
              [attr.aria-describedby]="taskStore.editError() ? 'edit-title-error-' + task.id : null"
            />
            <textarea
              #descriptionInput
              rows="4"
              (input)="taskStore.setDraftDescription(descriptionInput.value)"
              [value]="taskStore.draftDescription()"
            ></textarea>
            <button
              class="btn"
              type="button"
              (click)="taskStore.saveEdit(task.id)"
              [disabled]="taskStore.editTitleInvalid()"
            >
              Save
            </button>
            <button class="btn" type="button" (click)="taskStore.cancelEdit()">Cancel</button>
            @if (taskStore.editError()) {
              <p [id]="'edit-title-error-' + task.id" class="error" aria-live="polite">
                {{ taskStore.editError() }}
              </p>
            }
          } @else {
            <h3>{{ task.title }}</h3>
            <p>Description: {{ task.description ? task.description : 'No description' }}</p>
            <p>Status: {{ task.done ? 'Done' : 'Open' }}</p>
            <button class="btn" type="button" (click)="taskStore.toggleTask(task.id)">
              {{ task.done ? 'Mark as Open' : 'Mark as Done' }}
            </button>
            <button class="btn" type="button" (click)="startEdit(task)">Edit</button>
            <button class="btn" type="button" (click)="taskStore.deleteTask(task.id)">
              Delete
            </button>
          }
        </li>
      } @empty {
        <li>No tasks found.</li>
      }
    </ul>
  </div>
</section>
